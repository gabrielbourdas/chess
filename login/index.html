<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Open Chess - Acc√®s Membre</title>
    <link rel="icon" href="/img/logo.png" type="image/x-icon" />
    <link rel="stylesheet" href="../css/nav.css" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="../css/media.css" />
  </head>
  <body>
    <header>
      <nav>
        <ul class="sidebar">
          <li class="close-btn" onclick="hidesidebar()">
            <a href="#"><img src="/img/close.svg" alt="close" /></a>
          </li>
          <li class="sidebar-logo"><span>MENU</span></li>
          <li><a href="/Play/index.html">Play</a></li>
          <li><a href="/Puzzles/index.html">Puzzles</a></li>
          <li><a href="/Analyze/index.html">Analyze</a></li>
          <li><a href="/Learn/index.html">Learn</a></li>
        </ul>
        <ul>
          <li class="logo-container">
            <a href="/index.html" style="text-decoration: none">
              <h1 id="site-name">Open Chess</h1>
            </a>
          </li>
          <li class="hideOnMobile">
            <a href="/Play/index.html">Play <span></span></a>
          </li>
          <li class="hideOnMobile">
            <a href="/Puzzles/index.html">Puzzles <span></span></a>
          </li>
          <li class="hideOnMobile">
            <a href="/Analyze/index.html">Analyze <span></span></a>
          </li>
          <li class="hideOnMobile">
            <a href="/Learn/index.html">Learn <span></span></a>
          </li>
          <li class="menu-button" onclick="showsidebar()">
            <a href="#"><img src="/img/menu.svg" alt="menu" /></a>
          </li>
        </ul>
      </nav>
    </header>

    <main class="auth-main">
      <div class="auth-wrapper">
        <div id="login-box" class="auth-card fade-in">
          <div class="auth-header">
            <div class="auth-icon">üîê</div>
            <h2>Acc√®s au QG</h2>
            <p>Identifie-toi pour lancer une partie.</p>
          </div>

          <form action="#" class="auth-form">
            <div class="input-group">
              <label for="login-user">Email</label>
              <input
                type="text"
                id="login-user"
                placeholder="Rentrez votre email"
                required
              />
            </div>
            <div class="input-group">
              <label for="login-pass">Mot de passe</label>
              <input
                type="password"
                id="login-pass"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                required
              />
            </div>

            <div class="form-options">
              <label class="checkbox-container">
                <input type="checkbox" checked />
                <span class="checkmark"></span> Se souvenir
              </label>
              <a href="#" class="forgot-pass">Oubli√© ?</a>
            </div>

            <button type="submit" class="btn-login">Login</button>
          </form>

          <div class="auth-footer">
            <p>
              Nouveau challenger ?
              <a href="#" onclick="switchForm('register')">Cr√©er un compte</a>
            </p>
          </div>
        </div>

        <div id="register-box" class="auth-card hidden fade-in">
          <div class="auth-header">
            <div class="auth-icon">‚öîÔ∏è</div>
            <h2>Rejoindre le Club</h2>
            <p>Cr√©e ton profil pour suivre ta progression.</p>
          </div>

          <form action="#" class="auth-form">
            <div class="input-group">
              <label for="reg-user">Pseudo</label>
              <input
                type="text"
                id="reg-user"
                placeholder="Ton nom de guerre"
                required
              />
            </div>

            <div class="input-group">
              <label for="reg-email">Email (Optionnel)</label>
              <input
                type="email"
                id="reg-email"
                placeholder="Pour r√©cup√©rer le mot de passe"
              />
            </div>

            <div class="input-group">
              <label for="reg-pass">Mot de passe</label>
              <input
                type="password"
                id="reg-pass"
                placeholder="Choisis bien..."
                required
              />
            </div>

            <div class="input-group">
              <label for="reg-pass-conf">Confirmer</label>
              <input
                type="password"
                id="reg-pass-conf"
                placeholder="R√©p√®te le mot de passe"
                required
              />
            </div>

            <button type="submit" class="btn-login">
              Valider l'inscription
            </button>
          </form>

          <div class="auth-footer">
            <p>
              D√©j√† membre ?
              <a href="#" onclick="switchForm('login')">Se connecter</a>
            </p>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-content">
        <div class="footer-section">
          <h3>Open Chess</h3>
          <p>La plateforme ultime pour ma√Ætriser le jeu des rois.</p>
        </div>
        <div class="footer-section">
          <h3>Commencez l'aventure</h3>
          <a href="/login/index.html" class="btn-register"
            >S'inscrire Gratuitement</a
          >
        </div>
        <div class="footer-section">
          <h3>Liens Utiles</h3>
          <ul>
            <li><a href="/rules/index.html">R√®gles Simplifi√©es</a></li>
            <li><a href="/video/index.html">Cha√Æne YouTube</a></li>
            <li><a href="/support/index.html">Support</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>
          &copy; <span id="year">2026</span> Open Chess. Tous droits r√©serv√©s.
        </p>
      </div>
    </footer>

    <script type="module">
      // 1. IMPORT DU CERVEAU
      import { auth, db } from "../js/auth.js";

      // 2. IMPORT DES OUTILS (On ajoute sendPasswordResetEmail)
      import {
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        sendPasswordResetEmail, // <--- NOUVEAU : L'outil pour le reset
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      import {
        doc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // --- LOGIQUE D'INSCRIPTION (Rien ne change ici) ---
      const registerForm = document.querySelector("#register-box form");
      if (registerForm) {
        registerForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const email = document.getElementById("reg-email").value;
          const password = document.getElementById("reg-pass").value;
          const pseudo = document.getElementById("reg-user").value;
          const passConf = document.getElementById("reg-pass-conf").value;

          if (password !== passConf) {
            alert("Les mots de passe ne correspondent pas !");
            return;
          }

          createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              const user = userCredential.user;
              setDoc(doc(db, "users", user.uid), {
                pseudo: pseudo,
                email: email,
                progress: { opening: 0, puzzles: 0 },
              });
              alert("Bienvenue au club, " + pseudo + " !");
              window.location.href = "../index.html";
            })
            .catch((error) => {
              let msg = "Erreur : " + error.message;
              if (error.code === "auth/email-already-in-use")
                msg = "Cet email est d√©j√† utilis√©.";
              if (error.code === "auth/weak-password")
                msg = "Mot de passe trop faible (6 caract√®res min).";
              alert(msg);
            });
        });
      }

      // --- LOGIQUE DE CONNEXION (Rien ne change ici) ---
      const loginForm = document.querySelector("#login-box form");
      if (loginForm) {
        loginForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const email = document.getElementById("login-user").value;
          const password = document.getElementById("login-pass").value;

          signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              console.log("Connect√© !");
              window.location.href = "../index.html";
            })
            .catch((error) => {
              console.error(error);
              alert("Email ou mot de passe incorrect.");
            });
        });
      }

      // --- NOUVEAU : LOGIQUE MOT DE PASSE OUBLI√â ---
      const forgotBtn = document.querySelector(".forgot-pass");
      if (forgotBtn) {
        forgotBtn.addEventListener("click", (e) => {
          e.preventDefault(); // Emp√™che le lien de remonter la page

          // 1. On essaie de prendre l'email d√©j√† √©crit dans le champ
          let email = document.getElementById("login-user").value;

          // 2. Si le champ est vide, on demande l'email √† l'utilisateur
          if (!email) {
            email = prompt(
              "Entre ton adresse email pour recevoir le lien de r√©initialisation :",
            );
          }

          // 3. Si l'utilisateur a annul√© ou rien mis, on s'arr√™te
          if (!email) return;

          // 4. On envoie la demande √† Firebase
          sendPasswordResetEmail(auth, email)
            .then(() => {
              alert(
                "üìß Email envoy√© ! V√©rifie ta bo√Æte de r√©ception (et tes spams) pour changer ton mot de passe.",
              );
            })
            .catch((error) => {
              console.error(error);
              if (error.code === "auth/user-not-found") {
                alert("Aucun compte ne correspond √† cet email.");
              } else if (error.code === "auth/invalid-email") {
                alert("L'adresse email n'est pas valide.");
              } else {
                alert("Erreur : " + error.message);
              }
            });
        });
      }

      // --- FONCTIONS VISUELLES ---
      window.showsidebar = function () {
        document.querySelector(".sidebar").style.display = "flex";
        setTimeout(() => {
          document.querySelector(".sidebar").classList.add("active");
        }, 10);
      };
      window.hidesidebar = function () {
        document.querySelector(".sidebar").classList.remove("active");
        setTimeout(() => {
          document.querySelector(".sidebar").style.display = "none";
        }, 300);
      };

      window.switchForm = function (target) {
        const loginBox = document.getElementById("login-box");
        const registerBox = document.getElementById("register-box");
        if (target === "register") {
          loginBox.classList.add("hidden");
          registerBox.classList.remove("hidden");
        } else {
          registerBox.classList.add("hidden");
          loginBox.classList.remove("hidden");
        }
      };

      const yearSpan = document.getElementById("year");
      if (yearSpan) yearSpan.textContent = new Date().getFullYear();
    </script>
  </body>
</html>
