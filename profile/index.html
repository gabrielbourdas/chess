<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Open Chess | Mon Profil</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <link rel="stylesheet" href="../../css/style.css" />
    <link rel="stylesheet" href="../../css/nav.css" />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <header>
      <nav class="navbar">
        <a href="../../index.html" class="logo"
          >OPEN CHESS<span class="dot">.</span></a
        >
        <ul class="nav-links">
          <li><a href="../Play/index.html">Jouer</a></li>
          <li><a href="../Puzzles/index.html">D√©fis</a></li>
          <li><a href="../Analyse/index.html">Analyser</a></li>
          <li><a href="../Learn/index.html">Apprendre</a></li>
        </ul>
        <div class="nav-actions">
          <a href="#" class="btn-login" style="color: var(--accent-gold)"
            >Mon Compte</a
          >
        </div>
        <div class="hamburger" onclick="toggleMenu()">
          <span></span><span></span>
        </div>
      </nav>
      <div class="mobile-menu" id="mobileMenu">
        <a href="../../Play/index.html">Jouer</a>
        <a href="../../Puzzles/index.html">D√©fis</a>
        <a href="../../Learn/index.html">Apprendre</a>
        <a href="../../Analyze/index.html">Analyser</a>
      </div>
    </header>

    <main class="profile-main">
      <div class="dashboard-grid">
        <section class="dashboard-card identity-card">
          <div class="profile-avatar-container">
            <label
              for="file-input"
              class="avatar-label"
              title="Changer l'image"
            >
              <img
                id="profile-pic"
                src="https://api.dicebear.com/9.x/adventurer/svg?seed=Invit√©"
                alt="Avatar"
                class="avatar-img"
              />
              <div class="avatar-overlay"><i class="fas fa-camera"></i></div>
              <input type="file" id="file-input" accept="image/*" hidden />
            </label>
          </div>

          <div class="identity-info">
            <h1 id="profile-pseudo" class="pseudo-text">Chargement...</h1>
            <p id="profile-email" class="email-text">...</p>
            <p id="profile-date" class="date-text">Membre depuis ...</p>
          </div>
        </section>

        <section class="dashboard-card performance-card">
          <h2 class="card-title">Statistiques de Jeu</h2>

          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-header">
                <span class="stat-icon">üß©</span>
                <h3>Tactique</h3>
              </div>
              <div class="stat-content">
                <div class="stat-row">
                  <span class="label">Elo Actuel</span>
                  <span class="value gold" id="val-puzzle-elo">1200</span>
                </div>
                <div class="stat-row">
                  <span class="label">Meilleur Elo</span>
                  <span class="value" id="val-puzzle-best">1200</span>
                </div>
                <div class="stat-row">
                  <span class="label">R√©solus</span>
                  <span class="value" id="val-puzzle-solved">0</span>
                </div>
              </div>
            </div>

            <div class="stat-box">
              <div class="stat-header">
                <span class="stat-icon">üëÅÔ∏è</span>
                <h3>Visualisation</h3>
              </div>
              <div class="stat-content">
                <div class="stat-row">
                  <span class="label">Elo Actuel</span>
                  <span class="value gold" id="val-visu-elo">1000</span>
                </div>
                <div class="stat-row">
                  <span class="label">S√©rie Max</span>
                  <span class="value" id="val-visu-best">0</span>
                </div>
              </div>
            </div>
          </div>

          <div class="quick-action">
            <a href="../../Puzzles/index.html" class="text-link"
              >‚Üí Lancer une session d'entra√Ænement</a
            >
          </div>
        </section>

        <section class="dashboard-card settings-card">
          <h2 class="card-title">Param√®tres</h2>
          <div class="account-actions">
            <button id="logout-btn" class="action-btn outline-btn">
              D√©connexion
            </button>
            <button id="delete-account-btn" class="action-btn danger-btn">
              Supprimer le compte
            </button>
          </div>
        </section>
      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <div class="footer-brand">
          <h4>Open Chess<span class="dot">.</span></h4>
          <p>L'excellence strat√©gique √† port√©e de main.</p>
        </div>
        <div class="footer-copy">
          &copy; <span id="year">2026</span> Open Chess.
        </div>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        updateProfile,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBNBUO3JupohDCYAMs7Xf6kKgxnnFgPpVM",
        authDomain: "open-chess-2f3cf.firebaseapp.com",
        projectId: "open-chess-2f3cf",
        storageBucket: "open-chess-2f3cf.firebasestorage.app",
        messagingSenderId: "447945730536",
        appId: "1:447945730536:web:a1e3347bc13e94040bdc5d",
        measurementId: "G-71F05DTLHG",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // √âl√©ments DOM Identit√©
      const pseudoEl = document.getElementById("profile-pseudo");
      const emailEl = document.getElementById("profile-email");
      const dateEl = document.getElementById("profile-date");
      const picEl = document.getElementById("profile-pic");

      // √âl√©ments DOM Stats
      const puzzleEloEl = document.getElementById("val-puzzle-elo");
      const puzzleBestEl = document.getElementById("val-puzzle-best");
      const puzzleSolvedEl = document.getElementById("val-puzzle-solved");
      const visuEloEl = document.getElementById("val-visu-elo");
      const visuBestEl = document.getElementById("val-visu-best");

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // 1. Infos Auth de base
          emailEl.textContent = user.email;
          const creationDate = new Date(
            user.metadata.creationTime,
          ).toLocaleDateString("fr-FR");
          dateEl.textContent = "Membre depuis le " + creationDate;

          // 2. R√©cup√©ration Firestore (Stats + Pseudo)
          try {
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              const data = docSnap.data();

              // --- IDENTIT√â ---
              pseudoEl.textContent = data.pseudo || "Joueur";
              if (user.photoURL) picEl.src = user.photoURL;
              else
                picEl.src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${data.pseudo || "User"}`;

              // --- STATISTIQUES (Mapping des champs JS) ---
              // Puzzles
              puzzleEloEl.textContent = data.currentPuzzleElo || 1200;
              puzzleBestEl.textContent =
                data.bestPuzzleElo || data.currentPuzzleElo || 1200;
              puzzleSolvedEl.textContent = data.puzzlesSolved || 0;

              // Visualisation
              visuEloEl.textContent = data.currentVisuElo || 1000;
              visuBestEl.textContent =
                data.bestVisuElo || data.currentVisuElo || 1000;
            } else {
              pseudoEl.textContent = "Profil non initialis√©";
            }
          } catch (e) {
            console.error("Erreur Firestore:", e);
            pseudoEl.textContent = "Erreur chargement";
          }
        } else {
          window.location.href = "../../login/index.html";
        }
      });

      // Gestion de l'upload et d√©connexion inchang√©e
      const fileInput = document.getElementById("file-input");
      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const user = auth.currentUser;
        if (!user) return;
        picEl.style.opacity = "0.5";
        try {
          const storageRef = ref(storage, `avatars/${user.uid}`);
          await uploadBytes(storageRef, file);
          const photoURL = await getDownloadURL(storageRef);
          await updateProfile(user, { photoURL: photoURL });
          picEl.src = photoURL;
          picEl.style.opacity = "1";
        } catch (error) {
          console.error(error);
          picEl.style.opacity = "1";
        }
      });

      document.getElementById("logout-btn").addEventListener("click", () => {
        signOut(auth).then(() => (window.location.href = "../../index.html"));
      });

      document.getElementById("year").textContent = new Date().getFullYear();
      window.toggleMenu = function () {
        document.getElementById("mobileMenu").classList.toggle("active");
        document.querySelector(".hamburger").classList.toggle("active");
      };
    </script>
  </body>
</html>
