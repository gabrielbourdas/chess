<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Open Chess | Profil Grand MaÃ®tre</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <link rel="stylesheet" href="../../css/style.css" />
    <link rel="stylesheet" href="../../css/nav.css" />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <header>
      <nav class="navbar">
        <a href="../../index.html" class="logo"
          >OPEN CHESS<span class="dot">.</span></a
        >
        <ul class="nav-links">
          <li><a href="../Play/index.html">Jouer</a></li>
          <li><a href="../Puzzles/index.html">DÃ©fis</a></li>
          <li><a href="../Analyse/index.html">Analyser</a></li>
          <li><a href="../Learn/index.html">Apprendre</a></li>
        </ul>
        <div class="nav-actions">
          <a href="#" class="btn-login" style="color: var(--accent-gold)"
            >Mon Espace</a
          >
        </div>
        <div class="hamburger" onclick="toggleMenu()">
          <span></span><span></span>
        </div>
      </nav>
      <div class="mobile-menu" id="mobileMenu">
        <a href="../../Play/index.html">Jouer</a>
        <a href="../../Puzzles/index.html">DÃ©fis</a>
        <a href="../../Learn/index.html">Apprendre</a>
        <a href="../../Analyze/index.html">Analyser</a>
      </div>
    </header>

    <main class="profile-main">
      <div class="profile-container">
        <section class="profile-header">
          <div class="profile-avatar-container">
            <div class="avatar-wrapper">
              <img
                id="profile-pic"
                src="https://api.dicebear.com/9.x/adventurer/svg?seed=GrandMaster"
                alt="Avatar"
                class="avatar-img"
              />
              <div class="rank-badge">GM</div>
            </div>
            <input type="file" id="file-input" accept="image/*" hidden />
          </div>

          <div class="profile-info">
            <div class="info-top">
              <h1 id="profile-pseudo">Joueur</h1>
              <span class="country-flag" title="France">ðŸ‡«ðŸ‡·</span>
            </div>
            <p class="user-bio" id="profile-bio">
              "La tactique coule dans mes veines."
            </p>
            <div class="global-stats">
              <span id="profile-date"
                ><i class="fas fa-calendar-alt"></i> Depuis 2024</span
              >
              <span
                ><i class="fas fa-chess-pawn"></i>
                <span id="total-games">...</span> Parties</span
              >
            </div>
          </div>

          <div class="profile-actions">
            <button
              class="btn-edit"
              onclick="document.getElementById('file-input').click()"
            >
              <i class="fas fa-camera"></i> Photo
            </button>
            <button class="btn-settings" id="logout-btn" title="DÃ©connexion">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </section>

        <div class="stats-dashboard">
          <div class="dashboard-column">
            <h3 class="section-title">
              <i class="fas fa-graduation-cap"></i> Dojo Tactique
            </h3>

            <div class="stat-card puzzle-card">
              <div class="card-icon gold">
                <i class="fas fa-puzzle-piece"></i>
              </div>
              <div class="card-data">
                <h4>Tactique Classique</h4>
                <div class="big-number">
                  <span id="stat-classic-best">1200</span>
                  <span class="unit">Meilleur Elo</span>
                </div>
                <div class="sub-data">
                  <span><span id="stat-classic-solved">0</span> RÃ©solus</span>
                  <span class="separator">â€¢</span>
                  <span style="color: #e74c3c">
                    <i class="fas fa-fire"></i> SÃ©rie Max:
                    <strong id="stat-classic-streak">0</strong>
                  </span>
                </div>
              </div>
            </div>

            <div class="stat-card puzzle-card">
              <div class="card-icon blue"><i class="fas fa-eye"></i></div>
              <div class="card-data">
                <h4>Visualisation</h4>
                <div class="big-number">
                  <span id="stat-visu-best">1000</span>
                  <span class="unit">Meilleur Elo</span>
                </div>
                <div class="sub-data">
                  <span><span id="stat-visu-solved">0</span> RÃ©solus</span>
                  <span class="separator">â€¢</span>
                  <span style="color: #3498db">
                    <i class="fas fa-fire"></i> SÃ©rie Max:
                    <strong id="stat-visu-streak">0</strong>
                  </span>
                </div>
              </div>
            </div>

            <div class="stat-card puzzle-card sprint-card">
              <div class="card-icon red"><i class="fas fa-stopwatch"></i></div>
              <div class="card-data">
                <h4>Puzzle Sprint (30s)</h4>
                <div class="big-number">28 <span class="unit">Score</span></div>
                <div class="sub-data">
                  <span class="highlight">ðŸ”¥ Record Personnel</span>
                </div>
              </div>
              <div class="mini-chart">
                <div class="bar" style="width: 85%"></div>
              </div>
            </div>
          </div>

          <div class="dashboard-column">
            <h3 class="section-title">
              <i class="fas fa-trophy"></i> ArÃ¨ne & CompÃ©tition
            </h3>

            <div class="stat-card online-pvp-card">
              <div class="card-header">
                <h4><i class="fas fa-globe"></i> Parties en Ligne</h4>
                <span class="badge-level live">En direct</span>
              </div>

              <div class="pvp-mode-row">
                <div class="mode-icon green">
                  <i class="fas fa-stopwatch"></i>
                </div>
                <div class="mode-info">
                  <div class="mode-name">Rapide (10+0)</div>
                  <div class="mode-elo">1540</div>
                </div>
                <div class="mode-stats">
                  <span class="w-l">12W - 4L</span>
                  <div class="mini-bar">
                    <div class="fill" style="width: 75%"></div>
                  </div>
                </div>
              </div>

              <div class="pvp-mode-row">
                <div class="mode-icon yellow"><i class="fas fa-bolt"></i></div>
                <div class="mode-info">
                  <div class="mode-name">Blitz (3+2)</div>
                  <div class="mode-elo">1385</div>
                </div>
                <div class="mode-stats">
                  <span class="w-l">45W - 38L</span>
                  <div class="mini-bar">
                    <div class="fill" style="width: 55%"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="stat-card bot-card">
              <div class="card-header">
                <h4><i class="fas fa-robot"></i> Contre l'IA</h4>
                <span class="badge-level">Max: Niveau 6</span>
              </div>
              <div class="bot-stats-row">
                <div class="stat-item">
                  <span class="label">GagnÃ©es</span>
                  <span class="val win">42</span>
                </div>
                <div class="stat-item">
                  <span class="label">Nulles</span>
                  <span class="val draw">15</span>
                </div>
                <div class="stat-item">
                  <span class="label">Perdues</span>
                  <span class="val loss">28</span>
                </div>
              </div>
              <div class="win-rate-bar">
                <div class="segment win" style="width: 50%"></div>
                <div class="segment draw" style="width: 17%"></div>
                <div class="segment loss" style="width: 33%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="footer-inner">
        <div class="footer-brand">
          <h4>Open Chess<span class="dot">.</span></h4>
          <p>L'excellence stratÃ©gique Ã  portÃ©e de main.</p>
        </div>
        <div class="footer-copy">
          &copy; <span id="year">2026</span> Open Chess.
        </div>
      </div>
    </footer>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        updateProfile,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBNBUO3JupohDCYAMs7Xf6kKgxnnFgPpVM",
        authDomain: "open-chess-2f3cf.firebaseapp.com",
        projectId: "open-chess-2f3cf",
        storageBucket: "open-chess-2f3cf.firebasestorage.app",
        messagingSenderId: "447945730536",
        appId: "1:447945730536:web:a1e3347bc13e94040bdc5d",
        measurementId: "G-71F05DTLHG",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Ã‰lÃ©ments DOM IdentitÃ©
      const pseudoEl = document.getElementById("profile-pseudo");
      const dateEl = document.getElementById("profile-date");
      const picEl = document.getElementById("profile-pic");

      // Ã‰lÃ©ments DOM Stats Classique
      const classicBestEl = document.getElementById("stat-classic-best");
      const classicSolvedEl = document.getElementById("stat-classic-solved");
      const classicStreakEl = document.getElementById("stat-classic-streak");

      // Ã‰lÃ©ments DOM Stats Visualisation
      const visuBestEl = document.getElementById("stat-visu-best");
      const visuSolvedEl = document.getElementById("stat-visu-solved");
      const visuStreakEl = document.getElementById("stat-visu-streak");

      // --- 1. CHARGEMENT IDENTITÃ‰ & STATS ---
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const creationDate = new Date(
            user.metadata.creationTime,
          ).toLocaleDateString("fr-FR");
          if (dateEl)
            dateEl.innerHTML = `<i class="fas fa-calendar-alt"></i> Membre depuis ${creationDate}`;

          try {
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
              const data = docSnap.data();
              if (pseudoEl) pseudoEl.textContent = data.pseudo || "Joueur";

              // Affichage Avatar
              if (data.photoURL) {
                picEl.src = data.photoURL;
              } else if (user.photoURL) {
                picEl.src = user.photoURL;
              } else {
                picEl.src = `https://api.dicebear.com/9.x/adventurer/svg?seed=${data.pseudo || "User"}`;
              }

              // --- STATS CLASSIQUES ---
              // (Tes stats classiques existantes)
              if (classicBestEl)
                classicBestEl.textContent = data.bestPuzzleElo || 1200;
              if (classicSolvedEl)
                classicSolvedEl.textContent = data.puzzlesSolved || 0;
              const bestStreak = data.bestPuzzleStreak || 0;
              const currentStreak = data.puzzleStreak || 0;
              if (classicStreakEl)
                classicStreakEl.textContent = Math.max(
                  bestStreak,
                  currentStreak,
                );

              // --- STATS VISUALISATION (CORRIGÃ‰ & SIMPLIFIÃ‰) ---
              // On mappe directement les champs sauvegardÃ©s dans logic.js :
              // bestVisuElo, visuSolved, visuStreak

              if (visuBestEl) {
                visuBestEl.textContent = data.bestVisuElo || 0;
              }

              if (visuSolvedEl) {
                visuSolvedEl.textContent = data.visuSolved || 0;
              }

              if (visuStreakEl) {
                // Dans logic.js, 'visuStreak' contient dÃ©jÃ  le record max.
                visuStreakEl.textContent = data.visuStreak || 0;
              }
            }
          } catch (e) {
            console.error("Erreur Firestore:", e);
          }
        }
      });

      // --- 2. UPLOAD PHOTO (Base64) ---
      const fileInput = document.getElementById("file-input");
      if (fileInput) {
        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const user = auth.currentUser;
          if (!user) return;

          picEl.style.opacity = "0.5";

          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = function (event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = async function () {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              const MAX_SIZE = 300;
              let w = img.width,
                h = img.height;
              if (w > h) {
                if (w > MAX_SIZE) {
                  h *= MAX_SIZE / w;
                  w = MAX_SIZE;
                }
              } else {
                if (h > MAX_SIZE) {
                  w *= MAX_SIZE / h;
                  h = MAX_SIZE;
                }
              }
              canvas.width = w;
              canvas.height = h;
              ctx.drawImage(img, 0, 0, w, h);
              const base64 = canvas.toDataURL("image/jpeg", 0.7);

              try {
                await updateDoc(doc(db, "users", user.uid), {
                  photoURL: base64,
                });
                picEl.src = base64;
              } catch (err) {
                console.error(err);
                alert("Erreur upload");
              } finally {
                picEl.style.opacity = "1";
              }
            };
          };
        });
      }

      // --- 3. DÃ‰CONNEXION ---
      const btnLogout = document.getElementById("logout-btn");
      if (btnLogout) {
        btnLogout.addEventListener("click", () => {
          signOut(auth).then(() => (window.location.href = "../../index.html"));
        });
      }

      window.toggleMenu = function () {
        document.getElementById("mobileMenu").classList.toggle("active");
        document.querySelector(".hamburger").classList.toggle("active");
      };
      document.getElementById("year").textContent = new Date().getFullYear();
    </script>
  </body>
</html>
